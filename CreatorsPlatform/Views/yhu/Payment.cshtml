@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    int UserId = ViewBag.Id;
    int CreatoId = ViewBag.Cid;
    int PlamId = ViewBag.PlanId;
}
<style>
    img {
        max-width: 100px;
        max-height: 100px;
    }

    p {
        display: inline-block
    }

    #planPrice {
        float: right;
    }

    .creditCard {
        color: red;
    }

    input {
        display: inline-block
    }

    /*     input:valid {
            border: 2px solid green;
        }

        input:invalid {
            border: 2px solid red;
        } */
</style>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-7 px-0 border border-5 rounded">
            <div class="bg-light">
                <ul class="list-group">
                    <li class="list-group-item" position-relative m-4>
                        <img class="listImg float-md-start me-md-3 rounded-circle" src="data:image/*;base64,@(Convert.ToBase64String(@ViewBag.subPay[0].creatorAvatar))" />
                        <h3>
                            <span>
                                @ViewBag.subPay[0].planName
                            </span>
                        </h3>
                        <p id="planDes">@ViewBag.subPay[0].planDes</p>
                        <p id="creatorName">創作者：@ViewBag.subPay[0].creatorName</p>
                        <h5 id="planPrice">$@ViewBag.subPay[0].planPrice</h5>
                    </li>
                </ul>
            </div>
            <div class="text-center">
                <form onsubmit="return validateForm()">
                    <label for="CardNumber">信用卡號:</label><br>
                    <input type="text" id="cardNumber" name="CardNumber" pattern="(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6011[0-9]{12}|622((12[6-9]|1[3-9][0-9])|([2-8][0-9][0-9])|(9(([0-1][0-9])|(2[0-5]))))[0-9]{10}|64[4-9][0-9]{13}|65[0-9]{14}|3(?:0[0-5]|[68][0-9])[0-9]{11}|3[47][0-9]{13})" required><br><br>

                    <label for="CardholderName">持卡人名:</label><br>
                    <input type="text" id="cardholderName" name="CardholderName" required><br><br>

                    <label for="ExpiryDate">有效期限:</label><br>
                    <input type="month" name="ExpiryDate" id="expiryDate" required><br><br>

                    <label for="SecurityCode">安全碼:</label><br>
                    <input type="text" name="SecurityCode" id="securityCode" pattern="\d{3}" required><br><br>

                    <input type="submit" value="確認付款" id="subBtn" class="btn btn-warning border border-4 mb-2">
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $("#subBtn").click(function (event) {
            // 阻止表单默认提交行为
            event.preventDefault();

            // 获取信用卡号码
            let cardNumber = $("#cardNumber").val();
            let cardName = $("#cardHolderName").val();
            let expiryDate = $("#expiryDate").val();
            let securityCode = $("#securityCode").val();

            // 正则表达式规则
            let creditCardRegex = /^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6011[0-9]{12}|622((12[6-9]|1[3-9][0-9])|([2-8][0-9][0-9])|(9(([0-1][0-9])|(2[0-5]))))[0-9]{10}|64[4-9][0-9]{13}|65[0-9]{14}|3(?:0[0-5]|[68][0-9])[0-9]{11}|3[47][0-9]{13})*$/;

            let securityCoderegex = /^\d{3}$/;

            // 检查信用卡号码是否符合正则表达式规则
            if (creditCardRegex.test(cardNumber) && securityCoderegex.test(securityCode) && expiryDate !== "" && cardName !== "") {
                // 信用卡号码符合规则，执行提交操作

                var PlanDataToServer = {
                    UserId: @UserId,
                    PlanId: @PlamId,
                    CreatorId: @CreatoId
                            };
                $.ajax({
                    url: "/yhu/SubPayments",
                    method: "post",
                    data: PlanDataToServer,
                    success: function (response) {
                        alert("新增成功");
                        window.history.back();
                    },
                    error: function () {
                        alert('新增失敗');
                    }
                });
            } else {
                // 信用卡号码不符合规则，提醒用户重新输入或执行其他操作
                alert("信用卡不符合輸入規則，請確認後重新輸入！");
            }
        });
    });
</script>
