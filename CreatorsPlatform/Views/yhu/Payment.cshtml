@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    int UserId = ViewBag.Id;
    int CreatoId = ViewBag.Cid;
    int PlamId = ViewBag.PlanId;
}
<style>
    img {
        max-width: 100px;
        max-height: 100px;
    }

    p {
        display: inline-block
    }

    #planPrice {
        float: right;
    }

    .creditCard{
        color:red;
    }

    input{
        display: inline-block
    }

    input:valid {
        border: 2px solid green;
    }

    input:invalid {
        border: 2px solid red;
    }
</style>
<div class="container">
    <div class="row">
        <div class="col-8">
            <ul class="list-group">
                <li class="list-group-item" position-relative m-4>
                    <img class="listImg float-md-start me-md-3" src="data:image/*;base64,@(Convert.ToBase64String(@ViewBag.subPay[0].creatorAvatar))" />
                    <h3>
                        <span>
                            <a asp-controller="Lolm" asp-action="EventContent" asp-route-id="">
                                @ViewBag.subPay[0].planName
                            </a>
                        </span>
                    </h3>
                    <p id="planDes">@ViewBag.subPay[0].planDes</p>
                    <p id="creatorName">創作者：@ViewBag.subPay[0].creatorName</p>
                    <h5 id="planPrice">$@ViewBag.subPay[0].planPrice</h5>
                </li>
            </ul>
        </div>
        <div class="col-4">
            <div class="row border">
                <div class="row">
                    <p> <label for="CardNumber">卡號</label></p>
                    <p><input type="text" name="CardNumber" id="cardNumber" pattern="(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6011[0-9]{12}|622((12[6-9]|1[3-9][0-9])|([2-8][0-9][0-9])|(9(([0-1][0-9])|(2[0-5]))))[0-9]{10}|64[4-9][0-9]{13}|65[0-9]{14}|3(?:0[0-5]|[68][0-9])[0-9]{11}|3[47][0-9]{13})" required></p>
                    <p class="creditCard" id="noCardNumber"></p>
                </div>
                <div class="row">
                    <p><label for="CardholderName">持卡人名</label></p>
                    <p><input type="text" name="CardholderName" id="cardHolderName" required></p>
                    <p class="creditCard" id="noCardName"></p>
                </div>
                <div class="row">
                    <p><label for="ExpiryDate">有效期限</label></p>
                    <p>  <input type="month" name="ExpiryDate" id="expiryDate" required></p>
                    <p class="creditCard" id="noExpDate"></p>
                </div>
                <div class="row">
                    <p><label label for="SecurityCode">安全碼</label></p>
                    <p> <input type="text" name="SecurityCode" id="securityCode" required></p>
                    <p class="creditCard" id="noSecCode"></p>
                </div>
                <br /><br /><br />
                <div class="row">
                    <input id="subBtn" type="submit" value="Submit" class="btn btn-primary btn-lg btn-block">
                </div>
            </div>
        </div>
    </div>


   

    <script>
        $(document).ready(function () {
            $("#subBtn").click(function (event) {
                // 阻止表单默认提交行为
                event.preventDefault();

                // 获取信用卡号码
                let cardNumber = $("#cardNumber").val();
                let cardName = $("#cardHolderName").val();
                let expiryDate = $("#expiryDate").val();
                let securityCode = $("#securityCode").val();
                
                // 正则表达式规则
                let creditCardRegex = /^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6011[0-9]{12}|622((12[6-9]|1[3-9][0-9])|([2-8][0-9][0-9])|(9(([0-1][0-9])|(2[0-5]))))[0-9]{10}|64[4-9][0-9]{13}|65[0-9]{14}|3(?:0[0-5]|[68][0-9])[0-9]{11}|3[47][0-9]{13})*$/;

                let securityCoderegex = /^\d{3}$/;

                // 检查信用卡号码是否符合正则表达式规则
                if (creditCardRegex.test(cardNumber) && securityCoderegex.test(securityCode) && expiryDate !== "" && cardName !== "") {
                    // 信用卡号码符合规则，执行提交操作

                    var PlanDataToServer = {
                        UserId: @UserId,
                        PlanId: @PlamId,
                        CreatorId: @CreatoId
                        };
                    $.ajax({
                        url: "/yhu/SubPayments",
                        method: "post",
                        data: PlanDataToServer,
                        success: function (response) {
                            alert(response + "成功");
                            window.history.back();
                        },
                        error: function () {
                            alert('新增失敗');
                        }
                    });
                } else {
                    // 信用卡号码不符合规则，提醒用户重新输入或执行其他操作
                    alert("信用卡不符合輸入規則，請確認後重新輸入！");

                    
                    if (securityCoderegex.test(securityCode) !== true) {
                        $("#noSecCode").text("驗證碼錯誤");
                    };
                    if (expiryDate === "") {
                        $("#noExpDate").text("未填入到期日");
                    }
                    if (cardName === "") {
                        $("#noCardName").text("持卡人姓名錯誤");
                    }
                    if (creditCardRegex.test(cardNumber) !== true) {
                        $("#noCardNumber").text("信用卡號錯誤");
                    };
                }
            });
        });
    </script>
